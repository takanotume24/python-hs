# 実装計画

## 現在の到達点
- [x] マイルストーン 0: プロジェクト初期設定
- [x] マイルストーン 1: レキサー
- [x] マイルストーン 2: AST + パーサ
- [x] マイルストーン 3: 評価器（MVP）
- [x] マイルストーン 4: REPL + ランナー（MVP）
- [x] マイルストーン 5: 受け入れ（MVP）

## 現在のスコープ（P4: 仕様整合と品質維持）
- [x] P3 までの機能実装と仕様固定を完了
- [x] 反復上限仕様を `2000` で統一（plans / README / テスト / 実装の整合確認）
- [x] 反復上限の境界テストを明確化（`2000` は成功、`2001` は `Value error`）
- [x] P4 開始記録をメンテナンス履歴へ反映
- [ ] テスト可読性改善: `RuntimeErrorSpec` の関数呼び出し引数エラー巨大ケースを仕様単位へ分割
- [x] `float` 最小導入（literal: `1.23` / `1.` / `.5` / 指数表記、演算: `/` 実数除算・`//` 床除算、混在比較の暗黙昇格）
- [x] `float` 導入に伴う既存仕様差分の明文化（`/` 系期待値更新、表示規約、ゼロ除算エラー整合）

## 現在のスコープ（P5: VM基盤導入・並行運用）
- [x] P5 開始: AST評価器と並行して最小VM経路を追加する方針を開始
- [x] VM縦スライス1: `runSourceVm` を追加（lex/parse/compile/execute）
- [x] VM縦スライス1: 最小命令セット（定数push, load/store, add, print, halt）を導入
- [x] VM縦スライス1: 失敗テスト先行で `RunSourceVmSpec` を追加し、最小成功系/未対応文の失敗系を固定
- [x] VM縦スライス2: 制御構文（`if` / `while`）向けジャンプ命令とコンパイルを導入
- [x] VM縦スライス3: 関数呼び出し向け frame/call 命令を導入
- [x] VM縦スライス4: `float`・算術/比較・論理二項演算（`and`/`or`）をVM式評価へ導入
- [x] VM縦スライス5: `and` / `or` を厳密短絡評価へ更新（右辺副作用を抑止）
- [x] VM縦スライス6: 単項演算（`UnaryMinus` / `not`）をVM式評価へ導入
- [x] VM縦スライス7: `for` 文（`int/list/dict` 反復）をVM実行へ導入
- [x] VM縦スライス8: `break` / `continue` と反復上限ガード（2000）をVMへ導入
- [x] VM縦スライス9: `global` 文と複合代入（`+= -= *= /= %= //=`）をVMへ導入
- [x] VM縦スライス10: `len` / `bool` / `range` 組み込みをVM `CallFunction` 経路へ導入
- [x] VM縦スライス11: `append` / `sort` / `reverse` 組み込みをVM `CallFunction` 経路へ導入
- [x] VM縦スライス12: `remove` / `insert` / `pop` 組み込みをVM `CallFunction` 経路へ導入
- [x] VM縦スライス13: `clear` / `keys` / `get` / `update` / `setdefault` / `values` / `items` 組み込みをVM `CallFunction` 経路へ導入
- [x] VM縦スライス14: `runSource` と `runSourceVm` の parity テスト（MVPサブセット）を追加
- [x] VM縦スライス14: parity 対象を float / method-call style builtin / lexer-parse error まで拡張
- [x] VM縦スライス14: parity ケースを 20 件へ拡張（truthiness/global-pass/インデント複文/辞書順序/追加 runtime error）
- [x] VM縦スライス15: `runFile` に実行エンジンスイッチ（`PYTHON_HS_RUNNER_ENGINE=ast|vm`）を導入
- [x] VM縦スライス15: REPL経路は `vm` 指定時に未対応メッセージを返す保護動作を導入
- [x] VM縦スライス16: default 引数付き関数定義/呼び出しをVMで実行可能化
- [x] VM縦スライス17: keyword 引数付き関数呼び出し（ユーザー定義関数）をVMで実行可能化
- [x] VM縦スライス18: keyword 引数エラー系（duplicate/unexpected/multiple values/builtin keyword拒否）のVM回帰とparityを拡張
- [x] VM縦スライス19: keyword 引数の優先順位互換（builtin keyword拒否の先行判定、duplicate検出順）をVMで整合
- [x] VM縦スライス20: keyword 優先順位ケース（method-style builtin / unexpected vs multiple values / source-order）のparityを拡張
- [x] VM縦スライス21: default競合ケース（default内builtin keyword競合・count mismatch優先・default評価位置）のparityを拡張
- [x] VM縦スライス22: default参照/位置ケース（Name error位置・composite default・leftmost評価順）のparityを拡張
- [x] VM縦スライス23: `RunnerEdge` keyword残件（duplicate/unexpected/multiple values の優先順位・source-order）を parity/VM spec へ移植
- [x] VM縦スライス24: keyword 由来の parse 境界（mixed順序, `*`/`**` 展開, `*args`/`**kwargs`, keyword-only/positional-only separator）を parity/VM spec へ移植
- [x] VM縦スライス25: type annotation 由来の parse 境界（parameter annotation / return annotation）を parity/VM spec へ移植
- [x] VM縦スライス26: 非keyword parse 境界（header body欠落・standalone `elif/else`・先頭インデント・colon欠落）を parity/VM spec へ移植
- [x] VM縦スライス27: lexer 境界（unexpected character・dedent不整合・tab受理）を parity/VM spec へ移植
- [x] VM縦スライス28: `RunnerEdge` 関数/スコープ境界（暗黙return値・global関数全域適用・count mismatch補完）を parity/VM spec とVM実装へ反映
- [x] VM縦スライス29: `RunnerEdge` 統合成功系残件（if/elif/while代表スクリプト・`update({}, 1)`）を parity/VM spec へ移植
- [x] VM縦スライス30: `RunnerEdge` 前半エッジ残件（unary minus詳細・method-call位置エラー・builtin count mismatch位置・for range/list/dict）を parity/VM spec へ移植
- [x] VM縦スライス31: `RunnerEdge` との差分機械抽出で判明したVM欠落4件（default参照Name error 2件・keyword評価優先2件）を `RunSourceVmSpec` へ追補
- [x] VM縦スライス32: Haskell製 `check-runner-case-coverage` を追加（`RunnerEdge`/parity/VM 3ファイル比較、欠落ケースと件数を出力）
- [x] VM縦スライス33: `nix flake check` に `check-runner-case-coverage` を統合し、Nix経路で parity 欠落検査を自動実行
- [x] VM縦スライス34: interactive REPL executable テストの `python-hs` 解決を `Paths_python_hs.getBinDir` ベースへ変更し、`PYTHON_HS_SKIP_INTERACTIVE_REPL_TESTS` に依存しない実行へ移行

## 現在のスコープ（P6: REPL VMパリティ）
- [x] P6 開始: REPL の `vm` 未対応ガードを撤廃し、AST/VM 並行運用を REPL へ拡張する
- [x] 失敗テスト先行: `replEvalLines` の `PYTHON_HS_RUNNER_ENGINE=vm` で状態保持（代入→参照）を固定
- [x] REPL VM縦スライス1: `replEvalLines` に VM 実行経路を追加（逐次入力・ブロック確定・EOF flush）
- [x] REPL VM縦スライス1: `startRepl` に VM 実行経路を追加（対話入力・エラー継続）
- [x] REPL VM縦スライス1: 品質ゲート（`cabal test` / `cabal run check-structure`）を再実行
- [x] 品質ゲート強化: `check-runner-case-coverage` を欠落検出時に `exitFailure` する実質ゲートへ更新
- [x] REPL VM縦スライス2: VM REPL の単発式入力（例: `1 + 2`）を受理し、出力を返す
- [x] CLI縦スライス: `python-hs --engine ast|vm [file]` を追加し、REPL/ファイル実行でエンジン指定を受理
- [x] 品質ゲート強化: `check-runner-case-coverage` 実行バイナリの終了コード（欠落あり失敗 / 欠落なし成功）を統合テストで固定
- [x] ドキュメント整合: README に `cabal run python-hs -- --engine vm`（`--` 区切り必須）を追記
- [x] REPL VM縦スライス3: 単発式入力の表示を repr 互換化（string/list/dict を AST REPL と同形式で表示）

## 現在のスコープ（P7: VM数学機能MVP）
- [x] P7 開始: 今後の新機能は VM 実装のみを対象とし、AST 側への同等機能追加はスコープ外とする
- [x] 失敗テスト先行: `import math`（最小）と `math.sqrt/sin/cos/tan/log/exp/pi/e` の VM ケースを追加
- [x] 失敗テスト先行: 任意精度整数（巨大整数リテラル/演算）の VM ケースを追加
- [x] `import math` の最小構文を lexer/parser/AST に導入（専用MVP導線、汎用importは後続）
- [x] VM 実装: `IntValue` を `Integer` へ置換し、算術・比較・builtin の整合を取る
- [x] VM 実装: `math` 組み込みの最小セット（`sqrt/sin/cos/tan/log/exp/pi/e`）を追加
- [x] 品質ゲート再実行（`cabal test` / `cabal run check-structure` / warning 0）

### 運用メモ
- 受け入れテストは MVP 最小（`MvpScenarioSpec`）を維持し、詳細仕様は Runner/Eval の回帰テストで固定する。

---

## 短期TODO（次スプリント）
1. [x] 仕様明文化: `range` / `items` / `values` の順序保証（現状: 入力順, テストで固定済み）
2. [x] 仕様明文化: リスト・辞書組み込みのMVP境界（`pop` はMVP外, テストで固定済み）
3. [x] 仕様明文化: 呼び出し形式の方針（当初は関数形式のみ、後続で組み込みメソッド構文を導入）
4. [x] 回帰防止: 上記仕様を受け入れテスト（Runner）へ反映

---

## 中期ロードマップ（P2）
- [x] 式の網羅性を拡張（`*` / `/` / `%`、単項演算子の型規則統一）
- [x] コレクション操作を整理（`append` 返り値方針、`get` のデフォルト値仕様）
- [x] 反復モデルを整理（`for in range` と `for in list/dict` の整合、辞書反復はキー反復で定義）
- [x] エラーメッセージ規約を統一（Type/Value/Name エラーの語彙と位置表記）

---

## 長期ロードマップ（P3+）
- Python3サブセット拡張（`elif`、複合代入、真偽値/None など）
- 関数機能拡張（ローカル/グローバル解決規則、引数仕様の拡張）
- データ構造拡張（辞書更新API、将来的なミュータブル操作の整備）
- 品質基盤強化（受け入れシナリオ増強、エラー互換テスト、性能回帰監視）

### P3 次アクション（完了）
- [x] 複合代入の第1段階（`+=`）を導入（lex/parse/eval/runner）
- [x] `+=` の型規則を既存 `+` 規則に整合（int+int, string+string のみ）
- [x] `+=` の未定義識別子エラーを `Name error` 規約に整合
- [x] 回帰防止テスト（Lexer/Parser/Runtime/Runner）を追加
- [x] 複合代入の第2段階（`-=`）を導入（lex/parse/eval/runner）
- [x] 複合代入の第3段階（`*=`）を導入（lex/parse/eval/runner）
- [x] 複合代入の第4段階（`/=`）を導入（lex/parse/eval/runner）
- [x] 複合代入の第5段階（`%=`）を導入（lex/parse/eval/runner）
- [x] 複合代入の第6段階（`//=`）を導入（lex/parse/eval/runner）
- [x] `True` / `False` / `None` リテラルの最小導入（lex/parse/eval/runner）
- [x] `None` の truthiness を制御構文へ反映（if/while/not）
- [x] `None` 利用時のエラー互換を固定（len/算術の型エラー文言）
- [x] `bool(...)` 組み込みを最小導入（int/None 対応、型/引数エラー整備）
- [x] 関数本体からグローバル識別子を参照可能にする（ローカル優先で解決）
- [x] `bool(...)` の truthiness 対応を拡張（string/list/dict の空判定）
- [x] 制御構文/論理演算の truthiness を拡張（if/while/not/and/or で string/list/dict を許可）
- [x] 関数スコープ互換をテストで固定（引数シャドーイングと未定義識別子位置）
- [x] `global` 文を最小導入（lexer/parser/eval no-op）
- [x] `pass` 文を導入（lexer/parser/eval no-op）
- [x] `pass` と制御構文の相互作用テストを追加（if/while/for）
- [x] 反復上限ガードを導入（while/for の暴走を停止）
- [x] 複文ブロック対応の第1段階: `INDENT` / `DEDENT` を lexer に導入
- [x] 複文ブロック対応の第2段階: parser の suite 境界処理を修正（DEDENT 後の文継続を安定化）
- [x] 複文ブロック対応の第3段階: `if/elif/else` 複文後の後続文継続をテストで固定
- [x] 複文ブロック対応の第4段階: `elif` 内の入れ子条件分岐と後続文継続をテストで固定
- [x] 複文ブロック対応の第5段階: `while/for` 内の入れ子条件分岐と後続文継続をテストで固定
- [x] 複文ブロック対応の第6段階: インデント不整合（dedent不一致）の負系をテストで固定
- [x] 複文ブロック対応の第7段階: ブロックヘッダ直後にボディ欠落時の parse エラーをテストで固定
- [x] 複文ブロック対応の第8段階: `while/for` ヘッダ直後にボディ欠落時の parse エラーをテストで固定
- [x] 複文ブロック対応の第9段階: トップレベル不正 `elif/else` ヘッダの parse エラーをテストで固定
- [x] 複文ブロック対応の第10段階: 先頭インデント不正入力の parse エラーをテストで固定
- [x] 複文ブロック対応の第11段階: ヘッダ後に空行のみでボディ欠落する parse エラーをテストで固定
- [x] 複文ブロック対応の第12段階: 先頭タブ入力を空白として受理する現行仕様をテストで固定
- [x] 複文ブロック対応の第13段階: 行頭以外のタブ区切りを空白として受理する現行仕様をテストで固定
- [x] 複文ブロック対応の第14段階: 多段 `DEDENT` 終了後のトップレベル文継続を統合テストで固定
- [x] 複文ブロック対応の第15段階: ブロックヘッダのコロン欠落時 parse エラー位置をテストで固定
- [x] データ構造拡張の第1段階: `update(dict, key, value)` を導入（eval/runner）
- [x] データ構造拡張の第2段階: `pop(list)` を導入（末尾要素返却、空リストは Value error）
- [x] データ構造拡張の第3段階: `clear(list|dict)` を導入（eval/runner）
- [x] データ構造拡張の第4段階: `setdefault(dict, key, default)` を導入（eval/runner）
- [x] データ構造拡張の第5段階: `pop(dict, key[, default])` を導入（eval/runner）
- [x] データ構造拡張の第6段階: `remove(list, value)` を導入（eval/runner）
- [x] データ構造拡張の第7段階: `update(dict, otherDict)` を導入（辞書マージ, eval/runner）
- [x] データ構造拡張の第8段階: `setdefault(dict, key)` を導入（default省略時は `None`, eval/runner）
- [x] 呼び出し構文拡張の第1段階: 組み込みメソッド呼び出し（`x.append(3)`）を導入（lex/parse/runner）
- [x] 関数機能拡張の第1段階: デフォルト引数（`def f(a, b=2)`）を導入（parse/eval/runner）
- [x] 関数機能拡張の第2段階: 引数順序規則を追加（デフォルト引数の後に必須引数を禁止）
- [x] 関数機能拡張の第3段階: 関数定義の重複引数名を禁止（`def f(a, a)` は parse error）

### ブロック構文 仕様メモ（2026-02-24 時点）
- lexer は行頭スペースで `INDENT` / `DEDENT` を生成し、EOF 時に必要な `DEDENT` を flush する。
- `if / while / for / def` の suite は「インライン1文」または「改行 + インデント複文」を受理する。
- 複文終了時（`DEDENT`）は外側の文解析へ継続できる（後続トップレベル文を正しく解析する）。
- 不正ケース（ボディ欠落、トップレベル `elif/else`、不整合 dedent、先頭インデント不正）は parse/lexer エラーとして固定済み。
- タブは現行実装で空白として扱う（先頭タブ、トークン間タブとも受理）ため、その挙動をテストで固定済み。


## 品質ゲート
- 必須: `cabal test`
- 必須: `cabal run check-structure`
- 必須: コンパイラ警告 0

---

## メンテナンス記録（要約）
- 注記: 以下は時系列ログ。古い日付の「未対応」項目は、その後のエントリで仕様更新済みの場合がある。
- 2026-03-02
  - [x] P7継続: `README` に import 範囲（`math` のみ受理、他モジュールは `Import error`）を追記してMVP境界を明確化
  - [x] P7継続: `CLISpec` に VM `runFile` 経路の負系（`math.sqrt("x")` 型エラー / `import os` 未対応モジュール）を追加し、MVP境界を固定
  - [x] P7継続: `CLISpec` に VM `runFile` 経路の `math.sin/cos/tan/log/exp/e` 受け入れケースを追加し、math最小セットを実行導線で固定
  - [x] P7継続: `CLISpec` に VM `runFile` 経路の `import math` 受け入れケースを追加し、実運用導線で仕様を固定
  - [x] P7開始: VM専用方針を `plans.md` に反映し、AST parity 拡張を今回スコープ外へ明確化
  - [x] P7継続: 失敗テスト先行で `ScanTokensCoreSpec` / `ParseProgramSpec` / `RunSourceVmSpec` に `import math` と巨大整数ケースを追加
  - [x] P7継続: `IntValue` を `Integer` へ置換し、巨大整数リテラル/演算を VM 経路で実行可能化
  - [x] P7継続: `import math` 最小導線（lexer/parser/AST/VM compile）と `math.sqrt/sin/cos/tan/log/exp/pi/e` を実装
  - [x] P7継続: 構造制約対応として `ParseIfTail` / `RangeValues` / `CallCollectionBuiltin` / `CallMathBuiltin` へ責務分離し、200行制約を回復
  - [x] P7継続: 品質ゲート再実行（`cabal test` 682 examples green / `cabal run check-structure` pass）を確認
  - [x] P6継続: `processVmSubmission` の単発式フォールバックを `print __python_hs_repl_repr__(expr)` へ変更し、VM REPL の表示を repr 互換化
  - [x] P6継続: VM内部組み込み `__python_hs_repl_repr__` を追加し、`valueToReplOutput` を利用して REPL 表示文字列を生成
  - [x] P6継続: `CLISpec` に VM REPL の repr 表示ケース（string/dict）を追加し、失敗テスト先行でグリーン化
  - [x] P6継続: 品質ゲート再実行（`cabal test` / `cabal run check-structure`）で 678 examples green を確認
  - [x] P6継続: `RunnerCaseCoverageReportSpec` に `check-runner-case-coverage` 実行テストを追加し、欠落ありで `ExitFailure 1`・欠落なしで `ExitSuccess` を固定
  - [x] P6継続: `README` の使い方へ VM 起動手順を追記（`cabal run ... -- --engine vm` と環境変数指定）
  - [x] P6継続: 品質ゲート再実行（`cabal test` / `cabal run check-structure`）で 677 examples green を確認
  - [x] P6継続: `python-hs --engine ast|vm [file]` を追加し、`--engine vm` でREPL起動できるよう修正（未知値は `ast` へフォールバック）
  - [x] P6継続: VM REPL の単発式入力を `processVmSubmission` で検出し、式行のみ `print <expr>` へフォールバックして評価可能化
  - [x] P6継続: `CLISpec` に `--engine vm` 起動ケースと VM REPL 単発式ケースを追加し、失敗テスト先行でグリーン化
  - [x] P6継続: 品質ゲート再実行（`cabal test` / `cabal run check-structure`）で 675 examples green を確認
  - [x] P6継続: `check-runner-case-coverage` に欠落判定（`COUNT PARITY`/`COUNT VM` > 0）を追加し、欠落時に `exitFailure` する品質ゲートへ更新
  - [x] P6継続: `RunnerCaseCoverageHasMissing` を追加し、件数0/非0判定のユニットテスト（3件）を失敗テスト先行で追加してグリーン化
  - [x] P6継続: 品質ゲート再実行（`cabal test` / `cabal run check-structure`）で 673 examples green を確認
  - [x] P6開始: REPL の `PYTHON_HS_RUNNER_ENGINE=vm` 未対応ガードを撤廃し、`replEvalLines` / `startRepl` の両経路で VM 実行（逐次入力・複文確定・EOF flush・エラー継続）を有効化
  - [x] P6開始: `PythonHS.CLI.ProcessVmSubmission` を追加し、受理済みソース再実行 + 出力差分抽出で REPL の VM 状態保持（代入→参照）を実装
  - [x] P6開始: `CLISpec` の VM REPL ケースを「未対応メッセージ」から「状態保持で評価成功」へ更新し、失敗テスト先行でグリーン化
  - [x] P6開始: 品質ゲート再実行（`cabal test` / `cabal run check-structure`）で全通過を確認
  - [x] P5継続: interactive REPL executable テストの `python-hs` 解決を `getBinDir` 起点の近傍探索へ拡張し、Nixサンドボックス下でも `posix_spawnp: python-hs` を再発させない実行経路へ修正
  - [x] P5継続: `PYTHON_HS_SKIP_INTERACTIVE_REPL_TESTS` への依存を撤廃した状態で品質ゲートを再実行（`cabal run check-structure` / `cabal test` / `nix flake check -L path:.`）し、スキップなしで全通過を確認
  - [x] P5継続: `CLISpec` の interactive REPL executable テストで `python-hs` 実行パスを `Paths_python_hs.getBinDir` から解決するよう更新し、コマンド探索の外部 `PATH` 依存を除去
  - [x] P5継続: `flake.nix` の `preCheck` で設定していた `PYTHON_HS_SKIP_INTERACTIVE_REPL_TESTS=1` を削除し、スキップなしで `nix flake check` を通す構成へ修正
  - [x] P5継続: `nix flake check` で `check-runner-case-coverage` が `python-hs` 実行ファイルを見つけられず失敗したため、`flake.nix` の当該checkを `pythonHsWithChecks` 依存へ修正して `preCheck` の `PYTHON_HS_SKIP_INTERACTIVE_REPL_TESTS=1` を有効化
  - [x] P5継続: `check-structure` も同様に `pythonHsWithChecks` 依存へ揃え、Nixサンドボックス下での REPL 実行テスト失敗（`posix_spawnp: python-hs`）を回避
  - [x] P5継続: `PythonHS.Runner.RunnerCaseCoverageReport` の `tail` 使用による `-Wx-partial` 警告を除去（パターンマッチへ置換）
  - [x] P5継続: VM縦スライス33として `flake.nix` の `checks` に `check-runner-case-coverage` を追加し、`RunnerEdgeSpec` / `RunnerVmParitySpec` / `RunSourceVmSpec` の3ファイルを固定入力として検証するよう統合
  - [x] P5継続: `README` の Flake check 説明を更新し、検証内容を「テスト + 構造チェック + runner case coverage」へ同期
  - [x] P5継続: `nix flake check` 実行でNix経路の品質ゲートを確認
- 2026-03-01
  - [x] P5継続: VM縦スライス32として Haskell製の差分抽出CLI（`check-runner-case-coverage`）を追加し、`PythonHS.Runner.RunnerCaseCoverageReport` に抽出・集合差分・レポート整形ロジックを実装
  - [x] P5継続: 失敗テスト先行で `Test.Runner.RunnerCaseCoverageReportSpec` を追加し、欠落ケース検出（parity:1, vm:2）の期待値を固定
  - [x] P5継続: `python-hs.cabal` を更新（library公開モジュール、新規 executable、test-suite module）
  - [x] P5継続: focused実行（`--match "runnerCaseCoverageReport"`）で追加テストのグリーンを確認
  - [x] P5継続: 品質ゲート再実行（`cabal run check-structure` / `cabal test`）で 670 examples green を確認
  - [x] P5継続: VM縦スライス31として `RunnerEdge` との差分機械抽出を再実行し、VM側のみ欠落していた4ケース（`def f(a, b = 2, c = d)` / `def f(a, b = c, c = 2)` / `print f(a=len(1), b=len(1))` / `print f(1, b=len(1))`）を `RunSourceVmSpec` へ追加
  - [x] P5継続: focused実行（`--match "mirrors RunnerEdge exact source variants"`）で追補4ケースを含む対象群のグリーンを確認
  - [x] P5継続: 品質ゲート再実行（`cabal run check-structure` / `cabal test`）で 669 examples green を確認
  - [x] P5継続: VM縦スライス30として `RunnerEdge` 前半エッジ残件（unary minus literal/expr/type error、method-call styleの型/位置、builtin count mismatch call-site位置、for range/list/dict代表）を `RunSourceVmSpec` / `RunnerVmParitySpec` へ移植
  - [x] P5継続: focused実行（`--match "RunnerEdge"`）で追加ケースを含む対象群のグリーンを確認
  - [x] P5継続: 品質ゲート再実行（`cabal run check-structure` / `cabal test`）で 667 examples green を確認
  - [x] P5継続: VM縦スライス29として `RunnerEdge` の統合成功系残件（if/else+function, if/elif/else, while skip/repeat）と `update({}, 1)` 型エラーケースを `RunSourceVmSpec` / `RunnerVmParitySpec` へ移植
  - [x] P5継続: focused実行（`--match "RunnerEdge"`）で追加ケースを含む対象群のグリーンを確認
  - [x] P5継続: 品質ゲート再実行（`cabal run check-structure` / `cabal test`）で 660 examples green を確認
  - [x] P5継続: VM縦スライス28として `RunnerEdge` の関数/スコープ境界ケース（function body print + call、default trailing comma、count mismatch 3種、global read/shadow/new-global/branch-global）を `RunSourceVmSpec` / `RunnerVmParitySpec` へ移植
  - [x] P5継続: VM実装をAST規約へ整合（暗黙returnを `0` に統一、関数内 `global` を分岐有無にかかわらず関数全域で有効化）
  - [x] P5継続: 構造制約対応として `collectFunctionGlobalDecls` を `PythonHS.VM.CollectFunctionGlobalDecls` へ責務分離し、`RunInstructions.hs` の200行制約を回復
  - [x] P5継続: focused実行（`--match "RunnerEdge"`）→品質ゲート（`cabal run check-structure` / `cabal test`）で 654 examples green を確認
  - [x] P5継続: VM縦スライス27として `RunnerEdge` の lexer 境界（`UnexpectedCharacter '@'`, dedent不整合, 先頭/区切りタブ受理）を `RunSourceVmSpec` / `RunnerVmParitySpec` へ移植
  - [x] P5継続: focused実行（`--match "lexer"`）で lexer 境界追加ケースのグリーンを確認
  - [x] P5継続: 品質ゲート再実行（`cabal run check-structure` / `cabal test`）で 644 examples green を確認
  - [x] P5継続: VM縦スライス26として `RunnerEdge` の非keyword parse 境界（`print/global` malformed、`if/def/while/for` body欠落、standalone `elif/else`、先頭インデント、header colon欠落）を `RunSourceVmSpec` / `RunnerVmParitySpec` へ移植
  - [x] P5継続: focused実行（`--match "parse"`）で parse 境界追加ケースのグリーンを確認
  - [x] P5継続: 品質ゲート再実行（`cabal run check-structure` / `cabal test`）で 639 examples green を確認
  - [x] P5継続: VM縦スライス25として type annotation 由来 parse 境界（`def f(a: int)` / `def f() -> int`）を `RunSourceVmSpec` / `RunnerVmParitySpec` へ移植
  - [x] P5継続: focused実行（`--match "unsupported"`）で追加ケースを含む parse 境界のグリーンを確認
  - [x] P5継続: 品質ゲート再実行（`cabal run check-structure` / `cabal test`）で 623 examples green を確認
  - [x] P5継続: VM縦スライス24として `RunnerEdge` の keyword 由来 parse 境界ケース（mixed keyword→positional、`*[...]` / `**{}`、`*args` / `**kwargs`、`def f(*, a)` / `def f(a, /)`）を `RunSourceVmSpec` / `RunnerVmParitySpec` へ移植
  - [x] P5継続: keyword 優先順位残件（duplicate vs second Name、duplicate vs unexpected、unexpected/multiple values vs count mismatch）を parity/VM spec へ追加して固定
  - [x] P5継続: focused実行（`--match "keyword"` / `--match "unsupported"`）で追加ケースのグリーンを確認
  - [x] P5継続: 品質ゲート再実行（`cabal run check-structure` / `cabal test`）で 621 examples green を確認
  - [x] P5継続: VM縦スライス23として `RunnerEdge` の keyword 残件（first duplicate source-order、first keyword eval/Name precedence、multiple values 優先順位、first unexpected source-order）を `RunSourceVmSpec` / `RunnerVmParitySpec` へ移植
  - [x] P5継続: 実装差分なしで追加ケースが既存VMで満たされることを focused実行（`--match "keyword"`）で確認
  - [x] P5継続: 品質ゲート再実行（`cabal run check-structure` / `cabal test`）で 608 examples green を確認
  - [x] P5継続: VM縦スライス22として `RunnerEdge` の default参照/位置ケースを parity/VM spec へ移植（missing識別子位置、composite default位置、leftmost評価順）
  - [x] P5継続: VM Name error 文言を `undefined identifier` へ統一し、AST/evaluator とエラーメッセージ規約を整合
  - [x] P5継続: focused実行（`--match "default"`）→全体ゲートで 599 examples green を確認
  - [x] P5継続: VM縦スライス21として default競合ケースを `RunSourceVmSpec` / `RunnerVmParitySpec` に拡張（`duplicate/unexpected` vs default builtin keyword rejection）
  - [x] P5継続: default評価位置ケース（`b = 1 / 0`）と count mismatch 優先ケース（`print f(1)`）を parity に追加してAST/VM一致を固定
  - [x] P5継続: 実装差分なしで既存VMが仕様を満たすことを focused実行（`--match "default"`）と全体ゲートで確認
  - [x] P5継続: VM縦スライス20として `RunnerEdge` の keyword 優先順位ケースを `RunSourceVmSpec` / `RunnerVmParitySpec` へ移植拡張
  - [x] P5継続: 追加ケース（`len(x=missing)`, `d.update(k=1)`, `d.update(k=len(1))`, `f(1, a=2, b=3)`, `f(1,2,b=3,a=4)`, `f(b=len(1))`）で AST/VM 一致を固定
  - [x] P5継続: 実装差分なしでグリーン維持を確認（仕様固定の回帰拡張）
  - [x] P5継続: VM縦スライス19として `CallExpr` の引数コードを `CallFunction` 命令へ遅延保持し、実行時に左から評価する方式へ更新
  - [x] P5継続: builtin 呼び出しで keyword 引数を検出した場合、引数式評価より先に rejection を返す優先順位へ整合
  - [x] P5継続: user-defined 呼び出しで duplicate keyword を値式評価前に検出する優先順位へ整合
  - [x] P5継続: `EvaluateBuiltinArgs` / `EvaluateUserArgs` に責務分離し、構造制約（1ファイル1トップレベル関数/200行）と警告ゼロを維持
  - [x] P5継続: `RunSourceVmSpec` / `RunnerVmParitySpec` に precedence ケース（`len(x=len(1))`, `f(a=1, a=len(1))`）を追加して失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス18として keyword 引数エラー系（duplicate/unexpected/multiple values/builtin keyword拒否）を `RunSourceVmSpec` に追加
  - [x] P5継続: `RunnerVmParitySpec` に keyword 引数エラー系ケースを追加し、AST/VM のエラー互換を固定
  - [x] P5継続: 重点実行（`--match "keyword argument"`, `--match "multiple values for parameter"`）で失敗テスト先行を確認し、そのままグリーンを維持
  - [x] P5継続: VM縦スライス17として `CallFunction` 命令に引数種別メタデータ（positional/keyword）を追加し、keyword 呼び出し束縛をVM実行器で実装
  - [x] P5継続: `PythonHS.VM.BindCallArguments` を追加し、duplicate/unexpected/multiple values/count mismatch の束縛エラー規約をVM経路へ導入
  - [x] P5継続: `PythonHS.VM.CompileCallArgsAt` / `PythonHS.VM.FirstKeywordArg` へ責務分離し、`check-structure` の200行制約を維持
  - [x] P5継続: `RunSourceVmSpec` / `RunnerVmParitySpec` に keyword 呼び出し成功ケースを追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス16として `FunctionDefDefaultsStmt` を命令化し、default引数の省略呼び出しをVMで実行可能化
  - [x] P5継続: `CallFunction` 実行で default 式評価（呼び出し時評価・前段引数参照・副作用出力伝播）を追加
  - [x] P5継続: `RunSourceVmSpec` / `RunnerVmParitySpec` / `CLISpec` に default 引数ケースを追加・更新し、失敗テスト先行でグリーン化
  - [x] P5継続: `ResolveRunnerEngine` を追加して engine 解決ロジックを共有化（`runFile` / REPL）
  - [x] P5継続: `replEvalLines` / `startRepl` は `PYTHON_HS_RUNNER_ENGINE=vm` で未対応メッセージを返すガードを追加（REPLの環境保持・repr互換維持のため）
  - [x] P5継続: `CLISpec` に REPL `vm` 指定時の未対応メッセージケースを追加
  - [x] P5継続: `RunnerEngine` / `runSourceWithEngine` を追加し、AST/VM 実行経路を関数レベルで切替可能化
  - [x] P5継続: `CLI.RunFile` が `PYTHON_HS_RUNNER_ENGINE` を参照して `ast`（既定）/`vm` を切替する最小スイッチを導入
  - [x] P5継続: `CLISpec` に runFile の `vm` 切替ケースと未知値時の `ast` フォールバックケースを追加
  - [x] P5継続: `RunnerVmParitySpec` を20ケースへ拡張し、`runSource` と `runSourceVm` の一致範囲を RunnerCore/Edge 対応済み領域へ拡大
  - [x] P5継続: `RunnerVmParitySpec` のケースを15件へ拡張（trailing comma, float, nested pass, method-call style builtin, range拡張, runtime/lexer/parse error）
  - [x] P5継続: VM縦スライス14として `Test.Runner.RunnerVmParitySpec` を追加し、`runSource` と `runSourceVm` の結果一致をMVPサブセットで固定
  - [x] P5継続: parity 対象を代入/制御構文/関数/for/break-continue/global/複合代入/list・dict builtin/代表エラーへ拡張
  - [x] P5継続: VM縦スライス13として dict 系 builtin（`clear` / `keys` / `get` / `update` / `setdefault` / `values` / `items`）を追加
  - [x] P5継続: `RunSourceVmSpec` に dict 系 builtin の成功系・代表エラー系を追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス12として `remove` / `insert` / `pop` の builtin dispatch を追加
  - [x] P5継続: `RunSourceVmSpec` に list/dict の `pop` と `remove`/`insert` 成功系・代表エラー系を追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス11として `append` / `sort` / `reverse` の builtin dispatch を追加
  - [x] P5継続: `RunSourceVmSpec` に list builtin 成功系と型/引数エラーの代表ケースを追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス10として `len` / `bool` / `range` の builtin dispatch を `CallFunction` に追加
  - [x] P5継続: `PythonHS.VM.CallBuiltin` を新設し、引数個数/型エラー文言と `range` step=0 エラーを既存規約へ整合
  - [x] P5継続: `RunSourceVmSpec` に builtin 成功系（`len`/`bool`/`range`）と代表エラー系を追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス9として `DeclareGlobal` を導入し、関数内 `global` 宣言の代入先をグローバル環境へ反映
  - [x] P5継続: 複合代入文を `LoadName + ApplyBinary + StoreName` へコンパイルし、VM実行器で評価可能化
  - [x] P5継続: `RunSourceVmSpec` に複合代入と関数内 `global` 更新ケースを追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス8として `break` / `continue` をループ文脈付きコンパイルで導入し、ループ外使用時のエラー文言を互換化
  - [x] P5継続: `LoopGuard` 命令を導入し、`while` / `for` の反復上限（`maxLoopIterations`）をVM実行器で強制
  - [x] P5継続: `RunSourceVmSpec` に `break/continue` 制御と反復上限境界（2000/2001）ケースを追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス7として `ForSetup` / `ForNext` 命令を導入し、`for in int/list/dict` をVMで実行可能化
  - [x] P5継続: `ListExpr` / `DictExpr` を `BuildList` / `BuildDict` 命令へコンパイルし、for反復対象の式互換を拡張
  - [x] P5継続: `RunSourceVmSpec` に for反復成功系と iterable型エラーケースを追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス6として `ApplyUnaryMinus` / `ApplyNot` 命令を導入し、単項演算をVMで実行可能化
  - [x] P5継続: `RunSourceVmSpec` に単項演算（`-x`, `not 0/1/None`）ケースを追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス5として `CompileProgram` の式コンパイルをインデックス追跡化し、`and`/`or` をジャンプ命令ベースの厳密短絡へ更新
  - [x] P5継続: `RunSourceVmSpec` に短絡時の右辺未評価（副作用なし）テストを追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス4として `ApplyBinary` 命令を導入し、算術/比較/論理二項演算を実行器で評価可能化
  - [x] P5継続: `FloatExpr` / `NoneExpr` を `CompileProgram` でVM定数へ変換し、VM式カバレッジを拡張
  - [x] P5継続: `RunSourceVmSpec` に float演算・比較・論理演算の失敗テストを先行追加してグリーン化
  - [x] P5継続: VM縦スライス3として `def`/`call`/`return` の命令（`DefineFunction` / `CallFunction` / `ReturnTop`）を導入
  - [x] P5継続: `PythonHS.VM.RunInstructions` に関数フレーム実行（ローカル引数束縛・戻り値スタック復帰）を追加
  - [x] P5継続: `RunSourceVmSpec` に関数定義・呼び出し成功系を追加し、失敗テスト先行でグリーン化
  - [x] P5継続: VM縦スライス2として `if` / `while` のジャンプ命令（`JumpIfFalse` / `Jump`）を導入
  - [x] P5継続: `PythonHS.VM.CompileProgram` を制御構文対応し、`RunSourceVmSpec` に `if/else`・`while` 成功系を追加して固定
  - [x] 警告修正: `PythonHS.VM.RunInstructions` の truthiness 判定を全 `Value` コンストラクタ網羅へ修正
  - [x] P5開始: VM基盤導入マイルストーンを開始（MVP互換・並行運用）
  - [x] P5初回実装: `PythonHS.RunSourceVm` / `PythonHS.VM.*` を追加し、代入・`print`・`+` の最小実行をVM経路で実装
  - [x] P5初回テスト: `Test.VM.RunSourceVmSpec` を追加して失敗テスト先行→実装でグリーン化
  - [x] Runner拡張: `PythonHS.Runner` から `runSourceVm` を公開
  - [x] 運用ルール更新: 行数上限違反の解消で空行削除を禁止し、責務分離による別ファイル化を `AGENTS.md` に明記
  - [x] ドキュメント整合: `README` の float 関連仕様（literal形式、数値演算、`bool`/`sort`）を実装現状へ更新
  - [x] 追補（float互換）: 実行系で `1.` / `.5` / `1e3` / `1.2e-3` を固定する Eval/Runner テストを追加
  - [x] 不具合修正（float literal）: parser の `read` 失敗を回避するため `FloatToken` を正規化（先頭/末尾ドット補正）し、`1.` 実行時クラッシュを解消
  - [x] 追補（float互換）: `sort` を数値リスト（int/float混在）対応へ拡張し、非数値要素時は `Type error: sort expects list of number` を返す仕様で Eval/Runner テストを固定
  - [x] 追補（float互換）: `bool(0.0)==0` / `bool(0.5)==1` を Eval/Runner テストで固定し、builtin `bool` を `FloatValue` 対応
  - [x] 品質ゲート再確認（追補後）: `cabal test`（514 examples）/ `cabal run check-structure` 成功
  - [x] P4完了: `float` 導入を完了（Lexer/Parser/AST/Evaluator/Runner）し、`cabal test`（514 examples）と `cabal run check-structure` を通過
  - [x] 仕様固定（float literal）: `1.23` / `1.` / `.5` / 指数表記（`1e3`, `1.2e-3`）を受理することを Lexer/Parser テストで固定
  - [x] 仕様固定（数値演算）: `/` は実数除算、`//` は床除算、`%` は float 含む数値同士で評価可能とし、ゼロ除算メッセージ規約を維持
  - [x] 仕様固定（混在比較）: `int` と `float` の `== != < > <= >=` は暗黙昇格で評価することを Eval テストで固定
  - [x] 回帰防止（字句境界）: `1.append(2)` を `1.` と誤字句化しないことを Lexer テストで固定
  - [x] 仕様差分反映（Runner）: `/` と `/=` の期待出力を `3.5` / `4.0` へ更新
  - [x] P4スコープ拡張: `float` 導入マイルストーンを開始（literal拡張・評価規則更新・テスト再固定）
  - [x] P4開始: 計画管理の主軸を「P3機能追加」から「仕様整合と品質維持」へ移行
  - [x] 仕様整合: 反復回数ガードの正式仕様を `2000` 上限に統一（`2000` 成功 / `2001` 失敗）
  - [x] （引数評価エラーの優先順位・位置）
  - [x] 仕様固定（エラー優先順位: multiple values と内側Name errorの衝突）: `f(1, a=len(missing))` は multiple values 検出より先に内側 `len` の `Name error` を返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: multiple values と内側builtin keyword拒否の衝突）: `f(1, a=len(x=[1]))` は multiple values 検出より先に内側 `len` の builtin keyword 未対応エラーを返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: unexpected keyword と Name error の衝突）: `f(b=missing)` は unexpected keyword 検出より先に keyword 引数式の `Name error` を返し、`f(b=2)`/`f(1, b=2)` は従来どおり unexpected keyword を返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: multiple values と Name error の衝突）: `f(1, a=missing)` は keyword 引数式の `Name error` を返し、`f(1, a=2)` は multiple values 検出を返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: duplicate keyword と Name error の衝突）: `f(a=missing, a=2)` は先頭 keyword の `Name error` を返し、`f(a=1, a=missing)` は2番目 keyword の duplicate 検出を優先することを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: builtin keyword拒否 と Name error の衝突）: `len(x=missing)` は keyword 値式の `Name error` よりも builtin keyword 未対応エラーを優先して返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: method-style builtin keyword拒否 と引数式評価の衝突）: `d.update(k=len(1))` は keyword 値式の型エラーよりも method-style builtin keyword 未対応エラーを優先して返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: builtin keyword拒否 と引数式評価の衝突）: `len(x=len(1))` は keyword 値式の型エラーよりも builtin keyword 未対応エラーを優先して返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: unexpected keyword と引数式評価の衝突）: `f(b=len(1))` は unexpected keyword 検出より先に keyword 引数式の評価エラーを返し、`f(b=2)`/`f(1, b=2)` は従来どおり unexpected keyword を返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: multiple values と引数式評価の衝突）: `f(1, a=len(1))` は keyword 引数式の評価エラーを返し、`f(1, a=2)` は multiple values 検出を返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: duplicate keyword と引数式評価の衝突）: `f(a=len(1), a=2)` は先頭 keyword 引数式の評価エラーを返し、`f(a=1, a=len(1))` は2番目 keyword の duplicate 検出を優先することを Runner/Evaluator で固定
  - [x] 仕様固定（mixed call 右側keywordエラー位置）: 混在呼び出しで positional 引数式が成功し後続 keyword 引数式のみ失敗する場合（例: `f(1, b=len(1))`）、後続 keyword 引数式の位置でエラーを報告することを Runner/Evaluator で固定
  - [x] 仕様固定（keyword-only 右側エラー位置）: keyword-only 呼び出しで左側 keyword 引数式が成功し右側のみ失敗する場合（例: `f(a=1, b=len(1))`）、右側引数式の位置でエラーを報告することを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: keyword-only の左から評価）: keyword-only 呼び出しで複数引数式がエラーになり得る場合、左端の keyword 引数式エラー（例: `f(a=len(1), b=len(1))` の `a` 側）を優先して返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: positional + keyword の左から評価）: 混在呼び出しで positional/keyword 両方の引数式がエラーになり得る場合、左端の引数式エラー（例: `f(len(1), b=len(1))` の先頭 `len(1)`）を優先して返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: positional引数評価 vs default評価）: 呼び出し時に positional 引数式の評価エラーと未指定default式の評価エラーが競合する場合、positional 引数式のエラーを先に返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: 引数評価 vs default評価）: 呼び出し時に明示引数式の評価エラーと未指定default式の評価エラーが競合する場合、明示引数式のエラーを先に返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: 引数評価 vs default内builtin keyword拒否）: `def f(a, b=len(x=[1]))` で呼び出し時に明示/positional 引数式の評価エラーがある場合、未指定default側の builtin keyword 未対応エラーより先に引数式エラーを返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: duplicate/unexpected/multiple values vs default内builtin keyword拒否）: `def f(a,b,c=len(x=[1]))` の呼び出しで `duplicate keyword` / `unexpected keyword` / `multiple values` が起こる場合、未指定default側の builtin keyword 未対応エラーより先に各引数束縛エラーを返すことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: count mismatch vs default内builtin keyword拒否）: `def f(a,b,c=len(x=[1]))` の呼び出しで必須引数不足がある場合、未指定default側の builtin keyword 未対応エラーより先に `Argument count mismatch` を返すことを Runner/Evaluator で固定
  - [x] 仕様固定（count mismatch の位置規約）: ユーザー定義関数で `count mismatch` が発生する場合（引数過多・必須不足・keyword後positional の AST 直指定ケースを含む）、常に call-site 位置（`CallExpr` 位置）を報告することを Runner/Evaluator で固定
  - [x] 仕様固定（エラー優先順位: unexpected keyword vs multiple values）: 同一呼び出しで未知キーワードと多重束縛が同時に起こり得る場合（`f(1, a=2, b=3)`）、`multiple values` より先に `unexpected keyword` を返すことを Runner/Evaluator で固定
  - [x] 仕様固定（unexpected keyword の位置優先）: `f(1, z=2, b=3)` のように `unexpected keyword` と `count mismatch` が競合し得る場合でも、`count mismatch` の呼び出し位置ではなく最初の未知キーワード位置（`z`）を報告することを Runner/Evaluator で固定
  - [x] 仕様固定（unexpected keyword の報告順）: 未知キーワードが複数ある呼び出し（`f(z=1, b=2)`）では、辞書順ではなくソース順で最初に出現した未知キーワード（`z`）を報告することを Runner/Evaluator で固定
  - [x] 仕様固定（duplicate keyword の報告順）: 同一呼び出しで複数の duplicate 候補がある場合（`f(a=1, b=2, a=3, b=4)`）、ソース順で最初に検出される duplicate（`a`）を報告することを Runner/Evaluator で固定
  - [x] 仕様固定（multiple values の報告順）: 同一呼び出しで複数の multiple values 候補がある場合（`f(1,2,b=3,a=4)`）、パラメータ順ではなくソース順で最初に衝突した keyword 側（`b`）を報告することを Runner/Evaluator で固定
  - [x] 仕様固定（builtin count mismatch の位置規約）: 組み込み関数/メソッド呼び出し（`len` / `update` / `setdefault`）で引数個数不一致が発生する場合、常に call-site 位置を報告することを Runner/Evaluator で固定
  - [x] 回帰重複固定（RunnerCore）: 上記 builtin count mismatch の call-site 位置規約を `RunnerCoreSpec`（`len()` / `{}.update()`）にも重複追加し、統合回帰の耐性を強化
  - [x] テスト可読性改善: `RuntimeErrorSpec` の巨大ブロック（function call argument errors）から default衝突3ケースを独立 `it` へ分割し、仕様不変のまま保守性を向上
  - [x] テスト可読性改善: `RuntimeErrorSpec` の `reports dictionary builtin errors` を「型/値エラー」と「引数個数不一致」に分割し、仕様不変のまま見通しを改善
  - [x] テスト可読性改善: `RuntimeErrorSpec` の `reports pop builtin errors` を「型/値エラー」と「引数個数不一致」に分割し、仕様不変のまま見通しを改善
  - [x] テスト可読性改善: `RuntimeErrorSpec` の `clear` / `insert` / `remove` builtin エラーブロックを「型/値エラー」と「引数個数不一致」に分割し、`setdefault` は型エラー専用名へ整理して仕様不変のまま可読性を改善

  - [x] （default参照・評価順）
  - [x] 仕様固定（評価順: positional + keyword + default）: 混在呼び出し（例: `add(probe(1), c=probe(3))`）では positional/keyword 引数式を先に左から評価し、未指定 default式（例: `b=probe(a)`）を後続評価する順序を Runner/Evaluator で固定
  - [x] 仕様固定（keyword評価順×default参照）: keyword引数式（例: `a=probe(1)`）を先に評価し、その結果を参照する default式（例: `b=probe(a)`）が後続で評価される順序を Runner/Evaluator で固定
  - [x] 仕様固定（default参照 + keyword束縛）: keyword引数で束縛されたパラメータ（例: `add(a=3)`）を default引数式（`b=a`）が参照できることを Runner/Evaluator で固定
  - [x] 関数機能拡張（default参照）: default引数式は、呼び出し時に先行して束縛済みの引数/先行defaultを参照できるようにし、`def f(a, b=2, c=b)` を Runner/Evaluator で成功系固定
  - [x] 仕様更新履歴（default参照境界）: 旧挙動では `c = b` を `Name error` として固定していたが、同日更新で先行束縛参照を許可する仕様へ移行
  - [x] 仕様固定（default参照境界）: default引数式から明示引数パラメータ（例: `c=a`）を参照できることを Runner/Evaluator で固定
  - [x] 仕様固定（default参照境界）: default引数式から後続パラメータ（例: `b=c`）を参照した場合は未束縛として `Name error`（式内位置）になることを Runner/Evaluator で固定
  - [x] 仕様固定（default参照負系）: default引数式中の未知識別子参照（例: `c=d`）は引き続き `Name error`（式内位置）として Runner/Evaluator で固定
  - [x] 仕様固定（default評価順）: 明示指定と未指定が混在する場合でも、未指定default式はパラメータ順（左から）で評価されることを Runner/Evaluator で固定
  - [x] 仕様固定（default評価順）: 未指定defaultが複数ある場合、default式はパラメータ順（左から）で評価されることを Runner/Evaluator で固定
  - [x] 仕様固定（default副作用）: default式内の副作用付き呼び出しは、引数が未指定のときだけ実行され、明示指定時は実行されないことを Runner/Evaluator で固定

  - [x] （default式内の複合式・builtin・エラー位置）
  - [x] 仕様固定（default + builtin副作用）: default引数式に組み込み呼び出しを含む副作用付き式（例: `c=probe(len([a,b]))`）を置いた場合、引数未指定時のみ評価されることを Runner/Evaluator で固定
  - [x] 仕様固定（default + builtin副作用 上書き）: 上記 default が明示引数で上書きされた場合は default 式が評価されないことを Runner/Evaluator で固定
  - [x] 仕様固定（default + builtin）: default引数式で組み込み呼び出し（例: `c=len([a,b])`）を使い、先行束縛済み引数/defaultを参照して評価できることを Runner/Evaluator で固定
  - [x] 仕様固定（default複合式）: default引数式の複合参照（例: `c=b+a`）で、先行束縛済み引数/defaultを利用して評価できることを Runner/Evaluator で固定
  - [x] 仕様固定（default + builtin エラー位置）: default引数式で束縛済み値を介して組み込み型エラーが発生した場合（例: `b=len(a)` かつ `a` が int）、組み込み呼び出し位置を報告することを Runner/Evaluator で固定
  - [x] 仕様固定（default + builtin内識別子位置）: default引数式内の `len([a, missing])` のような式で未定義識別子が出た場合、識別子位置を `Name error` として報告することを Runner/Evaluator で固定
  - [x] 仕様固定（default複合式エラー位置）: default引数の複合式内で未知識別子を参照した場合、未定義識別子の位置（例: `d`）を `Name error` として報告することを Runner/Evaluator で固定
  - [x] 仕様固定（default評価順）: 明示指定と未指定が混在する場合でも、未指定default式はパラメータ順（左から）で評価されることを Runner/Evaluator で固定
  - [x] 仕様固定（default評価順）: 未指定defaultが複数ある場合、default式はパラメータ順（左から）で評価されることを Runner/Evaluator で固定
  - [x] 仕様固定（default副作用）: default式内の副作用付き呼び出しは、引数が未指定のときだけ実行され、明示指定時は実行されないことを Runner/Evaluator で固定
  - [x] 仕様固定（エラー位置）: default引数式内の組み込み型エラー（例: `len(1)`）も式内の呼び出し位置を報告することを Runner/Evaluator で固定
  - [x] 仕様固定（エラー位置）: default引数式の `Name error` 位置も式内識別子位置を報告することを Runner/Evaluator で固定
  - [x] 仕様固定（エラー位置）: default引数式の評価中に発生するランタイムエラーは、関数定義ヘッダ位置ではなく default 式内の演算位置を報告することを Runner/Evaluator で固定
  - [x] 仕様固定（default評価）: default引数式で参照する global 値は関数定義時ではなく呼び出し時点の環境を使うことを Runner/Evaluator の両層テストで固定
  - [x] 仕様固定（評価順）: default引数式と明示引数式が混在する場合、明示引数を先に評価し、未指定defaultのみ後続評価する順序を Runner/Evaluator の両層テストで固定
  - [x] 仕様固定（評価順）: 混在呼び出し（`positional + keyword`）でも引数式が左から順に評価されることを Runner/Evaluator の両層テストで固定
  - [x] 仕様固定（評価順）: keyword-only 呼び出し引数は左から順に評価されることを Runner/Evaluator の両層テストで固定
  - [x] 仕様明文化: メソッド呼び出し形式でも keyword 引数構文は parser で受理し、組み込み評価時に専用エラーで拒否する方針を固定
  - [x] 回帰追加（Parser/Runner/Evaluator）: `d.update(k=1)` 系ケースを追加し、AST生成と実行時拒否文言/位置を固定
  - [x] 回帰強化（Parser層）: 呼び出し引数境界を追加（`positional -> keyword(keyword...)` の受理、keyword群の末尾カンマ受理）
  - [x] 回帰強化（Parser層）: keyword引数列の後に positional が現れた場合の parse error 位置を追加固定
  - [x] 回帰強化（Evaluator層）: 関数呼び出しエラー優先順位（`duplicate` / `unexpected` / `multiple values`）を AST 直指定テストで固定
  - [x] 回帰強化（Evaluator層）: 組み込み関数の keyword 引数拒否を AST 直指定テストで固定
  - [x] 仕様明文化: ユーザー定義関数呼び出しのエラー優先順位を固定（`duplicate keyword` > `unexpected keyword` > `multiple values` > `count mismatch`）
  - [x] 回帰追加: `RunnerEdgeSpec` に優先順位を確認する3ケースを追加
  - [x] 組み込み関数ポリシー明文化: keyword 引数は未対応として専用エラーを返す（`Argument error: keyword arguments are not supported for builtin <name> at <pos>`）
  - [x] 回帰追加: `RunnerEdgeSpec` に `len(x=[1])` ケースを追加し、拒否文言と位置を固定
  - [x] 関数呼び出しエラー改善: 未知キーワード引数を専用エラーで報告（`Argument error: unexpected keyword argument <name> at <pos>`）
  - [x] 回帰追加: `RunnerEdgeSpec` に `f(b=2)` ケースを追加し、エラー文言と位置を固定
  - [x] 関数呼び出しエラー改善: 重複キーワード引数を専用エラーで報告（`Argument error: duplicate keyword argument <name> at <pos>`）
  - [x] 関数呼び出しエラー改善: 位置引数とキーワード引数の多重束縛を専用エラーで報告（`Argument error: multiple values for parameter <name> at <pos>`）
  - [x] 回帰追加: `RunnerEdgeSpec` に上記2ケースを追加してエラー文言と位置を固定
  - [x] 関数呼び出し拡張（最小）: 位置引数→キーワード引数の混在（`f(1, b=2)`）を導入
  - [x] 仕様整理: `keyword -> positional`（`f(a=1, 2)`）は引き続き parse error として固定
  - [x] 回帰更新: `mixed positional then keyword` の Parser/Runner 負系を成功系へ置換
  - [x] 関数呼び出し拡張（最小）: 呼び出し側キーワード引数 `f(a=1)` を導入（AST/parse/eval/runner）
  - [x] 仕様整理: キーワード引数はユーザー定義関数呼び出しで有効、位置引数との混在は引き続き parse error として固定
  - [x] 回帰更新: `ParserErrorSpec` の `f(a=1)` 未対応固定を撤回し、`ParseProgramSpec` と `RunnerEdgeSpec` の成功系へ置換
- 2026-02-28
  - [x] 回帰防止（Parser/Runner）: 関数定義の戻り値型注釈（`def f() -> int`）は未対応として parse error を固定
  - [x] 回帰防止（Parser/Runner）: 関数定義の型注釈記法（`def f(a: int)`）は未対応として parse error を固定
  - [x] 回帰防止（Parser/Runner）: 呼び出し側の位置/キーワード混在（`f(1, a=2)`, `f(a=1, 2)`）は未対応として parse error を固定
  - [x] 回帰防止（Parser/Runner）: 定義側位置専用区切り（`def f(a, /)`）は未対応として parse error を固定
  - [x] 回帰防止（Parser/Runner）: 定義側キーワード専用区切り（`def f(*, a)`）は未対応として parse error を固定
  - [x] 回帰防止（Parser/Runner）: 呼び出し側の辞書展開（`f(**{})`）は未対応として parse error を固定
  - [x] 回帰防止（Parser/Runner）: 呼び出し側の引数展開（`f(*[1,2])`）は未対応として parse error を固定
  - [x] 回帰防止（Parser/Runner）: 可変引数構文（`def f(*args)`, `def f(**kwargs)`）は未対応として parse error を固定
  - [x] 回帰防止（Parser/Runner）: 呼び出し側キーワード引数（`f(a=1)`）は未対応として parse error を固定
  - [x] 回帰防止（Parser/Runner）: 重複引数名 + デフォルト引数（`def f(a=1, a=2)`）の parse error をテストで固定
  - [x] 関数機能拡張: 重複引数名を禁止（`def f(a, a)` を parse error 化）
  - [x] 回帰防止（Parser/Runner）: 重複引数名の負系テストを追加し、エラー位置を固定
  - [x] 回帰防止（Parser/Runner）: デフォルト引数付き関数定義の末尾カンマ（`def f(a, b=2,)`）をテストで固定
  - [x] 回帰防止（Parser単体）: デフォルト引数付き関数定義の AST 生成を `ParseProgramSpec` で固定
  - [x] 回帰防止（Parser単体）: デフォルト引数後の必須引数を禁止する parse error 位置を `ParserErrorSpec` で固定
  - [x] 関数機能拡張: 引数順序規則を追加（`def f(a=1, b)` は parse error）
  - [x] 回帰防止: `RunnerEdgeSpec` にデフォルト引数後の必須引数を禁止する負系テストを追加
  - [x] 関数機能拡張: デフォルト引数付き関数定義を追加（`def add(a, b = 2): ...`）
  - [x] 関数呼び出し拡張: 省略された末尾引数をデフォルト式で補完する評価を追加
  - [x] 回帰防止: `RunnerEdgeSpec` にデフォルト引数の成功系/引数不足エラー系テストを追加
  - [x] REPL互換改善: 辞書の文字列キー表示（`{'k': 1}` 形式）を単体/対話REPLテストで固定
  - [x] REPL互換改善: 文字列式結果のエスケープ表示（`\t` / `\\` / `\'`）をテストで固定
  - [x] REPL受け入れ強化: 対話REPL実行テストに文字列エスケープ表示ケースを追加
  - [x] REPL互換改善: 式結果表示を `print` 出力と分離し、REPL専用フォーマット（repr風）を導入
  - [x] REPL互換改善: 文字列の式結果をクオート付き（`'...'`）で表示するよう変更
  - [x] 回帰防止: `CLISpec` に REPL文字列表示のクオートと list 内要素表示の repr 互換テストを追加
  - [x] REPL受け入れ強化: 対話REPL実行テストに式結果表示（変数利用・複合式）を追加
  - [x] REPL受け入れ強化: 対話REPL実行テストに `None` 式結果の非表示ケースを追加
  - [x] REPL改善: 単独式入力（例: `1 + 2`）を文パース失敗時に式として評価し、結果を表示するフォールバックを追加
  - [x] REPL改善: 式評価結果が `None` の場合は表示しない挙動を追加（CPython互換の最小挙動）
  - [x] 回帰防止: `CLISpec` に REPL式表示（通常/環境利用/None抑制）テストを追加
  - [x] REPL改善: `exit()` 入力で対話REPLを終了できるよう `startRepl` を更新（通常評価せず終了）
  - [x] REPL改善: `replEvalLines` でも `exit()` で入力列評価を打ち切る挙動を追加
  - [x] 回帰防止: `CLISpec` に `exit()` 終了テスト（`replEvalLines` / 対話実行）を追加
  - [x] 品質ゲート再確認: `cabal test`（339 examples）/ `cabal run check-structure` 成功
- 2026-02-26
  - [x] P3継続: `setdefault(dict, key)` を追加（default省略時に `None` を補完、関数/メソッド形式を eval/runner で固定）
  - [x] P3継続: `update(dict, otherDict)` を追加（既存キー上書き+新規キー追加の辞書マージを eval/runner で固定）
  - [x] CI調整: GitHub Actions に `libncurses-dev` インストール手順を追加し、`haskeline` の `-ltinfo` リンク依存を満たすよう修正
  - [x] 非Nix再確認: `cabal test`（332 examples）/ `cabal run check-structure` 成功（`libncurses-dev` 導入後）
  - [x] REPL拡張: 入力処理を `haskeline` に移行し、矢印キーでの編集・履歴操作を有効化
  - [x] 依存調整: `python-hs.cabal` の library 依存に `haskeline` を追加
  - [x] 環境調整: `cabal.project` に `constraints: haskeline -terminfo` を追加（非Nix環境でのリンク回避を試行）
  - [x] Nix調整: `flake.nix` の dev shell に `ncurses` を追加し、REPL依存ライブラリを提供
  - [x] 品質ゲート（Nix）: `nix develop -c cabal test`（332 examples）/ `nix develop -c cabal run check-structure` 成功
  - [x] REPL調査: 初回/エラー後にプロンプトが出ない問題を修正（`isEOF` 先行判定を廃止し、入力待ちを `getLine` のEOF処理へ変更）
  - [x] REPL調査: 対話実行でのプロンプト回帰テストを追加（先頭 `>>>` 表示とエラー後の再表示を固定）
  - [x] REPL調査: EOF時に未送信バッファを評価して終了するよう `startRepl` を修正（ブロック入力終端の取りこぼしを解消）
  - [x] REPL調査: `CLISpec` を拡張（空行扱い、EOF送信、実行時エラー後継続、失敗後の環境維持、対話実行のEOFフラッシュ）
  - [x] 品質ゲート再確認: `cabal test`（331 examples）/ `cabal run check-structure` 成功
  - [x] P3継続: 辞書メソッド構文の回帰面を補完（`values/items/get(default)/pop(default)` と代表負系を固定）
  - [x] P3継続: 組み込みメソッド呼び出しを拡張（`remove` / `insert` / `sort` / `reverse` を受け入れテストで固定）
  - [x] P3継続: メソッド呼び出し時の型エラー位置互換を固定（`print 1.append(2)` で `at 1:9`）
  - [x] P3継続: 組み込みメソッド呼び出しを拡張（`update` / `pop` / `clear` の list/dict ケースを受け入れテストで固定）
  - [x] P3継続: 組み込みメソッド呼び出しの適用範囲を拡張（連鎖呼び出し・辞書組み込みの受け入れテストを追加）
  - [x] P3継続: 組み込みメソッド呼び出しの最小導入（`x.append(3)` を `append(x, 3)` と等価に評価）
  - [x] P3継続: `remove(list, value)` を追加（先頭一致要素のみ削除、未発見は Value error を eval/runner で固定）
  - [x] 開発環境の再現性向上のため `flake.nix` を追加（`nix develop` で GHC/Cabal/HLS/整形・Lint ツールを提供）
  - [x] `flake.nix` に `checks` を追加し、`nix flake check` でテストと `check-structure` を実行可能化
  - [x] `checks.cabal-test` を `runCommand` ラッパー化し、`nix flake check -L` 時にテスト実行済みログを明示
  - [x] `README` に `nix flake check -L path:.`（ログ表示あり）手順を追記
- 2026-02-24
  - [x] READMEを新規作成し、実装済みPythonサブセット機能とMVP境界（未対応範囲）を明文化
- 2026-02-19
  - [x] `PythonHS.CLI` を機能別モジュールへ分割
  - [x] 構造チェックを Haskell 実装へ移行
  - [x] 命名規約・ファイル粒度ルールへの準拠を完了
- 2026-02-20
  - [x] パーサ: `if/else` 改行ケース対応
  - [x] 評価器: `if` / `while` / 関数ランタイムのテスト強化
  - [x] エラー報告: `ParserErrorSpec` / `RuntimeErrorSpec` 追加
  - [x] 統合: `RunnerSpec` / `CLISpec` / `MvpScenarioSpec` 拡充
  - [x] P1開始: 文字列のレキサー・パーサ対応
  - [x] P1継続: 文字列の `print` と文字列変数の `print` 対応
  - [x] P1継続: 文字列連結 `"a" + "b"` 対応（混在型は型エラー維持）
  - [x] P1継続: 組み込み `len` を追加（成功/型エラー/引数個数エラーをテスト化）
  - [x] P1継続: 文字列比較 `==` / `!=` の評価器・統合テストを追加
  - [x] P1継続: `for` / `break` / `continue` と `range`（1引数）を追加
    - ループ内 `break` / `continue` の制御伝播
    - ループ外 `break` / `continue` の位置付きエラー
  - [x] P1継続: リストの最小導入（`[1, 2]` の lex/parse/eval/runner）
  - [x] P1継続: `for ... in <list>` を追加（`range(n)` と併存）
  - [x] P1継続: 組み込み `len` を `list` に拡張（`len("abc")` と `len([1,2])` の併存）
  - [x] P1継続: 組み込み `append(list, value)` を追加（新規リストを返す）
  - [x] P1継続: 型規則エラーメッセージを整理（`+` 混在型、`for` iterable エラー）
  - [x] P1継続: 辞書の最小導入（`{k: v}` の lex/parse/eval/runner）
  - [x] P1継続: 辞書組み込み `keys(dict)` / `get(dict, key)` を追加
  - [x] P1継続: 組み込み `values(dict)` / `items(dict)` を追加
  - [x] P1継続: `range(start, stop[, step])` を追加（step=0 は runtime error）
  - [x] P1継続: 単項マイナスを拡張（`-2`, `-x`, `-(1+2)`）
  - [x] P1継続: 単項マイナスの型エラー文言を明確化（`-"a"` で専用メッセージ）
  - [x] P1継続: `keys` / `values` / `items` の入力順維持をテストで固定
  - [x] P1継続: MVP境界を固定（`pop` は未対応）
  - [x] P1継続: 組み込み呼び出しを関数形式に固定（メソッド構文は未対応）
  - [x] P2開始: 乗除剰余（`*` / `/` / `%`）を lexer/parser/evaluator に追加
  - [x] P2継続: `get(dict, key, default)` を追加（未発見時 default を返す）
  - [x] P2継続: `for ... in {k:v}` を追加（辞書はキー反復、挿入順を維持）
  - [x] P2継続: 未定義識別子/関数エラーを `Name error` 語彙に統一
  - [x] P3開始: `elif` を lexer/parser/runner に追加（`if` の else-if 連鎖をサポート）
  - [x] P3継続: 複合代入 `+=` を追加（既存 `+` 型規則と Name error 規約を適用）
  - [x] P3継続: 複合代入 `-=` を追加（int専用、Name error 規約を適用）
  - [x] P3継続: 複合代入 `*=` を追加（int専用、Name error 規約を適用）
  - [x] P3継続: 複合代入 `/=` を追加（int専用、ゼロ除算は Value error）
  - [x] P3継続: 複合代入 `%=` を追加（int専用、ゼロ剰余は Value error）
  - [x] P3継続: 複合代入 `//=` を追加（int専用、ゼロ除算は Value error）
  - [x] P3継続: `True` / `False` / `None` リテラルを追加（print/比較の最小互換）
  - [x] P3継続: `None` を falsy として評価（if/while/not/and/or で 0 と同等扱い）
  - [x] P3継続: `None` 利用時のエラー互換を固定（`None + 1` と `len(None)` の型エラー文言）
  - [x] P3継続: `bool(...)` 組み込みを追加（int/None の最小truthiness変換）
  - [x] P3継続: 関数からグローバル変数の読み取りを許可（引数はローカル優先）
  - [x] P3継続: `bool(...)` を空文字/空リスト/空辞書でも評価可能に拡張
  - [x] P3継続: `if/while/not/and/or` を空文字/空リスト/空辞書でも評価可能に拡張
  - [x] P3継続: 関数スコープ互換テストを追加（引数優先解決と Name error 位置）
  - [x] P3継続: `global` 文を追加（キーワード認識・構文解析・実行時 no-op）
  - [x] P3継続: `pass` 文を追加（トップレベル/関数本体で no-op）
  - [x] P3継続: `pass` の制御構文内ケースを受け入れテストで固定（if/while/for）
  - [x] P3継続: 反復回数ガードを追加（while/for 2000回超で Value error）
  - [x] P3継続: インデント字句化を追加（`INDENT` / `DEDENT` の発行）
  - [x] P3継続: parser の suite 境界処理を修正（DEDENT 後に次文を継続可能化）
  - [x] P3継続: `if/elif/else` 複文後の後続文継続を parser/runner テストで固定
  - [x] P3継続: `elif` ブランチ内の入れ子条件分岐と後続文継続を parser/runner テストで固定
  - [x] P3継続: `while/for` ブランチ内の入れ子条件分岐と後続文継続を parser/runner テストで固定
  - [x] P3継続: インデント不整合（dedent不一致）の lexer/runner エラーを固定
  - [x] P3継続: `if/def` ヘッダ直後にボディ欠落時の parse エラー位置を parser/runner テストで固定
  - [x] P3継続: `while/for` ヘッダ直後にボディ欠落時の parse エラー位置を parser/runner テストで固定
  - [x] P3継続: トップレベル不正 `elif/else` ヘッダの parse エラー位置を parser/runner テストで固定
  - [x] P3継続: 先頭インデント不正入力（`  print 1`）の parse エラー位置を parser/runner テストで固定
  - [x] P3継続: `if/while` ヘッダ後に空行のみでボディ欠落する parse エラー位置を parser/runner テストで固定
  - [x] P3継続: 先頭タブ入力（`\tprint 1`）を空白として受理する現行挙動を lexer/runner テストで固定
  - [x] P3継続: 行頭以外のタブ区切り（`x\t=\t1`, `print\tx`）を空白として受理する現行挙動を lexer/runner テストで固定
  - [x] P3継続: 多段 `DEDENT`（`while/for/if` ネスト終了）後のトップレベル文継続を Runner 統合テストで固定
  - [x] P3継続: `if/while/for/def` ヘッダのコロン欠落時 parse エラー位置を parser/runner テストで固定
  - [x] P3継続: `update(dict, key, value)` を追加（既存キー更新/新規キー追加を eval/runner で固定）
  - [x] P3継続: `pop(list)` を追加（末尾要素返却、空リスト/型/引数個数エラーを eval/runner で固定）
  - [x] P3継続: `clear(list|dict)` を追加（空コレクション返却、型/引数個数エラーを eval/runner で固定）
  - [x] P3継続: `setdefault(dict, key, default)` を追加（既存キーは不変、未存在キーは追加、型/引数個数エラーを eval/runner で固定）
  - [x] P3継続: `pop(dict, key[, default])` を追加（キー存在時は値返却、未存在時はdefault返却/エラーを eval/runner で固定）
  - [x] 最新品質ゲート: `cabal test`（264 examples） / `cabal run check-structure` 成功
  - [x] CI改善: GitHub Actions に Cabal キャッシュ（`~/.cabal/packages`, `~/.cabal/store`, `dist-newstyle`）を追加
